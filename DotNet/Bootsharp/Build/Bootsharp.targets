<Project>

    <UsingTask TaskName="Bootsharp.Builder.BuildBootsharp" AssemblyFile="$(BootsharpBuilderAssembly)"/>

    <Target Name="BootsharpBuild" AfterTargets="_AfterWasmBuildApp">

        <!-- Generate bindings, types and (optionally) embed binaries. -->
        <BuildBootsharp BuildDirectory="$(BootsharpBuildDirectory)"
                        EntryAssemblyName="$(BootsharpEntryAssemblyName)"
                        EmbedBinaries="$(BootsharpEmbedBinaries)"/>

        <!-- Copy bootsharp source files to the build directory. -->
        <ItemGroup>
            <BootsharpSourceFiles Include="$(BootsharpSourceDirectory)/*.*"/>
        </ItemGroup>
        <Copy SourceFiles="@(BootsharpSourceFiles)" DestinationFolder="$(BootsharpBuildDirectory)"/>
        <Move SourceFiles="$(BootsharpBuildDirectory)/bootsharp.d.ts"
              DestinationFiles="$(BootsharpBuildDirectory)/$(BootsharpName).d.ts"/>

        <!-- Compile generated JavaScript solution. -->
        <Exec Command="npx rollup bootsharp.js -o $(BootsharpPublishDirectory)/$(BootsharpName).js -f es -g process,module"
              WorkingDirectory="$(BootsharpBuildDirectory)"/>

        <!-- Publish binaries and type declarations. -->
        <ItemGroup>
            <BootsharpWasmFiles Include="$(BootsharpBuildDirectory)/*.wasm"/>
            <BootsharpTypeFiles Include="$(BootsharpBuildDirectory)/*.d.ts"/>
        </ItemGroup>
        <RemoveDir Directories="$(BootsharpBinariesDirectory);$(BootsharpTypesDirectory)"/>
        <Copy Condition="'$(BootsharpEmbedBinaries)' != 'true'"
              SourceFiles="@(BootsharpWasmFiles)"
              DestinationFolder="$(BootsharpBinariesDirectory)"/>
        <Copy SourceFiles="@(BootsharpTypeFiles)"
              DestinationFolder="$(BootsharpTypesDirectory)"/>

        <!-- Publish package file. -->
        <ItemGroup>
            <BootsharpPackageTemplate Include="$(BootsharpRoot)/build/PackageTemplate.json"/>
            <BootsharpPackageFile Include="$(BootsharpPackageDirectory)/package.json"/>
        </ItemGroup>
        <WriteLinesToFile Condition="!Exists('$(BootsharpPackageFile)')"
                          File="$(BootsharpPackageFile)"
                          Lines="$([System.IO.File]::ReadAllText($(BootsharpPackageTemplate))
                                 .Replace('%MODULE_NAME%','$(BootsharpName)')
                                 .Replace('%MODULE_DIR%','$([System.IO.Path]::GetRelativePath('$(BootsharpPackageDirectory)','$(BootsharpPublishDirectory)'))')
                                 .Replace('%TYPES_DIR%','$([System.IO.Path]::GetRelativePath('$(BootsharpPackageDirectory)','$(BootsharpTypesDirectory)'))'))"/>

        <Message Text="Bootsharp ES module published at $(BootsharpPublishDirectory)" Importance="high"/>

    </Target>

</Project>
