<Project>

    <PropertyGroup>
        <OutputType>Exe</OutputType>
        <Configuration>Release</Configuration>
        <RuntimeIdentifier>browser-wasm</RuntimeIdentifier>
        <InvariantTimezone>true</InvariantTimezone>
        <InvariantGlobalization>true</InvariantGlobalization>
        <WasmStripILAfterAOT>true</WasmStripILAfterAOT>
        <BootsharpBuilderAssembly>$(MSBuildThisFileDirectory)../tasks/Bootsharp.Builder.dll</BootsharpBuilderAssembly>
        <BootsharpJSDir>$(MSBuildThisFileDirectory)../js</BootsharpJSDir>
        <BootsharpPublishDir>$(BaseOutputPath)/bootsharp</BootsharpPublishDir>
        <BootsharpBuildDirectory>$(WasmAppDir)/_framework</BootsharpBuildDirectory>
        <BootsharpEntryAssemblyName>$(AssemblyName).dll</BootsharpEntryAssemblyName>
        <BootsharpEmbedBinaries>true</BootsharpEmbedBinaries>
    </PropertyGroup>

    <UsingTask TaskName="Bootsharp.Builder.BuildBootsharp" AssemblyFile="$(BootsharpBuilderAssembly)"/>

    <Target Name="BootsharpBuild" AfterTargets="_AfterWasmBuildApp">

        <!-- generate bindings, types and (optionally) embed binaries -->
        <BuildBootsharp BuildDirectory="$(BootsharpBuildDirectory)"
                        EntryAssemblyName="$(BootsharpEntryAssemblyName)"
                        EmbedBinaries="$(BootsharpEmbedBinaries)"/>

        <!-- copy bootsharp source JavaScript files to the build directory -->
        <ItemGroup>
            <BootsharpSourceFiles Include="$(BootsharpJSDir)/*.*"/>
            <BootsharpWasmFiles Include="$(BootsharpBuildDirectory)/*.wasm"/>
        </ItemGroup>
        <Copy SourceFiles="$(BootsharpSourceFiles)" DestinationFolder="$(BootsharpBuildDirectory)"/>

        <!-- append generated binding types to source declarations -->
        <ItemGroup>
            <BootsharpSourceTypes Include="$(BootsharpBuildDirectory)/bootsharp-main.d.ts"/>
            <BootsharpGeneratedTypes Include="$(BootsharpBuildDirectory)/bootsharp-bindings.d.ts"/>
        </ItemGroup>
        <ReadLinesFromFile File="@(BootsharpGeneratedTypes)">
            <Output TaskParameter="Lines" ItemName="BootsharpGeneratedTypeLines"/>
        </ReadLinesFromFile>
        <WriteLinesToFile Lines="@(BootsharpGeneratedTypeLines)" File="@(BootsharpSourceTypes)"/>

        <!-- compile generated JavaScript solution -->
        <Exec Command="npm install --global rollup" WorkingDirectory="$(BootsharpBuildDirectory)"/>
        <Exec Command="rollup bootsharp-main.js -o bootsharp.js -f es -g process,module"
              WorkingDirectory="$(BootsharpBuildDirectory)"/>

        <!-- publish compiled solution -->
        <RemoveDir Directories="$(BootsharpPublishDir)"/>
        <Move SourceFiles="$(BootsharpBuildDirectory)/bootsharp-main.d.ts"
              DestinationFiles="$(BootsharpBuildDirectory)/bootsharp.d.ts"/>
        <Copy SourceFiles="$(BootsharpBuildDirectory)/bootsharp.js;
                           $(BootsharpBuildDirectory)/bootsharp.d.ts;
                           $(BootsharpBuildDirectory)/bootsharp.js.map"
              DestinationFolder="$(BootsharpPublishDir)"/>
        <Copy Condition="'$(BootsharpEmbedBinaries)' != 'true'"
              SourceFiles="$(BootsharpWasmFiles)"
              DestinationFolder="$(BootsharpPublishDir)/bin"/>
        <Message Text="Bootsharp ES module published at $(BootsharpPublishDir)" Importance="high"/>

    </Target>

</Project>
