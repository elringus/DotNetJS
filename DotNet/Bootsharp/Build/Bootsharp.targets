<Project>

    <PropertyGroup>

        <!-- Project defaults common to the build target. -->
        <OutputType>Exe</OutputType>
        <Configuration>Release</Configuration>
        <RuntimeIdentifier>browser-wasm</RuntimeIdentifier>
        <InvariantTimezone>true</InvariantTimezone>
        <InvariantGlobalization>true</InvariantGlobalization>
        <WasmStripILAfterAOT>true</WasmStripILAfterAOT>

        <!-- Bootsharp public defaults. -->
        <!-- Name of the generated JavaScript module; 'bootsharp' by default. -->
        <BootsharpName>bootsharp</BootsharpName>
        <!-- Name of the entry (main) assembly for the WASM target; equals final output assembly by default. -->
        <BootsharpEntryAssemblyName>$(AssemblyName).dll</BootsharpEntryAssemblyName>
        <!-- Directory to publish generated JavaScript module files; 'bin/module-name' by default. -->
        <BootsharpPublishDirectory>$(BaseOutputPath)/$(BootsharpName)</BootsharpPublishDirectory>
        <!-- Directory to publish 'package.json' file; same as publish directory by default. -->
        <BootsharpPackageDirectory>$(BootsharpPublishDir)</BootsharpPackageDirectory>
        <!-- Whether to embed binary wasm files to the JavaScript module file (true or false); true by default. -->
        <BootsharpEmbedBinaries>true</BootsharpEmbedBinaries>
        <!-- Whether to disable some .NET features to reduce binary size (true or false); false by default. -->
        <BootsharpAggressiveTrimming>false</BootsharpAggressiveTrimming>

        <!-- Bootsharp internal defaults. -->
        <BootsharpRoot>$(MSBuildThisFileDirectory)../</BootsharpRoot>
        <BootsharpSourceDirectory>$(BootsharpRoot)/js</BootsharpSourceDirectory>
        <BootsharpBuildDirectory>$(WasmAppDir)/_framework</BootsharpBuildDirectory>
        <BootsharpBuilderAssembly>$(BootsharpRoot)/tasks/Bootsharp.Builder.dll</BootsharpBuilderAssembly>

    </PropertyGroup>

    <Choose>
        <When Condition="$(BootsharpAggressiveTrimming)">
            <PropertyGroup>
                <!-- https://learn.microsoft.com/en-us/aspnet/core/blazor/performance?#minimize-app-download-size -->
                <!-- https://raw.githubusercontent.com/dotnet/runtime/main/docs/workflow/trimming/feature-switches.md -->
                <PublishTrimmed>true</PublishTrimmed>
                <TrimMode>full</TrimMode>
                <TrimmerRemoveSymbols>true</TrimmerRemoveSymbols>
                <_AggressiveAttributeTrimming>true</_AggressiveAttributeTrimming>
                <AutoreleasePoolSupport>false</AutoreleasePoolSupport>
                <DebuggerSupport>false</DebuggerSupport>
                <EnableCppCLIHostActivation>false</EnableCppCLIHostActivation>
                <EnableUnsafeBinaryFormatterSerialization>false</EnableUnsafeBinaryFormatterSerialization>
                <EnableUnsafeBinaryFormatterInDesigntimeLicenseContextSerialization>false</EnableUnsafeBinaryFormatterInDesigntimeLicenseContextSerialization>
                <EnableUnsafeUTF7Encoding>false</EnableUnsafeUTF7Encoding>
                <_EnableConsumingManagedCodeFromNativeHosting>false</_EnableConsumingManagedCodeFromNativeHosting>
                <EventSourceSupport>false</EventSourceSupport>
                <HttpActivityPropagationSupport>false</HttpActivityPropagationSupport>
                <MetadataUpdaterSupport>false</MetadataUpdaterSupport>
                <UseNativeHttpHandler>true</UseNativeHttpHandler>
                <UseSystemResourceKeys>true</UseSystemResourceKeys>
                <StartupHookSupport>false</StartupHookSupport>
                <CustomResourceTypesSupport>false</CustomResourceTypesSupport>
                <BuiltInComInteropSupport>false</BuiltInComInteropSupport>
            </PropertyGroup>
        </When>
    </Choose>

    <UsingTask TaskName="Bootsharp.Builder.BuildBootsharp" AssemblyFile="$(BootsharpBuilderAssembly)"/>

    <Target Name="BootsharpBuild" AfterTargets="_AfterWasmBuildApp">

        <!-- Generate bindings, types and (optionally) embed binaries. -->
        <BuildBootsharp BuildDirectory="$(BootsharpBuildDirectory)"
                        EntryAssemblyName="$(BootsharpEntryAssemblyName)"
                        EmbedBinaries="$(BootsharpEmbedBinaries)"/>

        <!-- Copy bootsharp source module files to the build directory. -->
        <Copy SourceFiles="$(BootsharpSourceDirectory)/bootsharp-main.js;
                           $(BootsharpSourceDirectory)/bootsharp-main.d.ts"
              DestinationFolder="$(BootsharpBuildDirectory)"/>

        <!-- Append generated binding types to source declarations. -->
        <ItemGroup>
            <BootsharpSourceTypes Include="$(BootsharpBuildDirectory)/bootsharp-main.d.ts"/>
            <BootsharpGeneratedTypes Include="$(BootsharpBuildDirectory)/bootsharp-bindings.d.ts"/>
        </ItemGroup>
        <ReadLinesFromFile File="@(BootsharpGeneratedTypes)">
            <Output TaskParameter="Lines" ItemName="BootsharpGeneratedTypeLines"/>
        </ReadLinesFromFile>
        <WriteLinesToFile Lines="@(BootsharpGeneratedTypeLines)" File="@(BootsharpSourceTypes)"/>

        <!-- Compile generated JavaScript solution. -->
        <Exec Command="npm install --global rollup" WorkingDirectory="$(BootsharpBuildDirectory)"/>
        <Exec Command="rollup bootsharp-main.js -o $(BootsharpName).js -f es -g process,module"
              WorkingDirectory="$(BootsharpBuildDirectory)"/>

        <!-- Publish compiled solution. -->
        <Move SourceFiles="$(BootsharpBuildDirectory)/bootsharp-main.d.ts"
              DestinationFiles="$(BootsharpBuildDirectory)/$(BootsharpName).d.ts"/>
        <Copy SourceFiles="$(BootsharpBuildDirectory)/$(BootsharpName).js;
                           $(BootsharpBuildDirectory)/$(BootsharpName).d.ts;
                           $(BootsharpBuildDirectory)/$(BootsharpName).js.map"
              DestinationFolder="$(BootsharpPublishDirectory)"/>
        <ItemGroup>
            <BootsharpWasmFiles Include="$(BootsharpBuildDirectory)/*.wasm"/>
        </ItemGroup>
        <RemoveDir Directories="$(BootsharpPublishDirectory)/bin"/>
        <Copy Condition="'$(BootsharpEmbedBinaries)' != 'true'"
              SourceFiles="@(BootsharpWasmFiles)"
              DestinationFolder="$(BootsharpPublishDirectory)/bin"/>

        <!-- Publish package file. -->
        <ItemGroup>
            <PackageTemplate>$(BootsharpRoot)/build/PackageTemplate.json</PackageTemplate>
            <PackageFile>$(BootsharpPackageDirectory)/package.json</PackageFile>
        </ItemGroup>
        <WriteLinesToFile Condition="!Exists('$(PackageFile)')"
                          File="$(PackageFile)"
                          Lines="$([System.IO.File]::ReadAllText($(PackageTemplate))
                                 .Replace('%NAME%','$(BootsharpName)')
                                 .Replace('%PATH%','$([System.IO.Path]::GetRelativePath('$(BootsharpPackageDirectory)','$(BootsharpPublishDirectory)'))'))"/>

        <Message Text="Bootsharp ES module published at $(BootsharpPublishDirectory)" Importance="high"/>

    </Target>

</Project>
