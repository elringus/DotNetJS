<Project>

    <PropertyGroup>
        <BootsharpRoot>$(MSBuildThisFileDirectory)../</BootsharpRoot>
        <BootsharpSourceDirectory>$(BootsharpRoot)/js</BootsharpSourceDirectory>
        <BootsharpBuilderAssembly>$(BootsharpRoot)/tasks/Bootsharp.Builder.dll</BootsharpBuilderAssembly>
    </PropertyGroup>

    <Choose>
        <When Condition="$(BootsharpAggressiveTrimming)">
            <PropertyGroup>
                <!-- https://learn.microsoft.com/en-us/aspnet/core/blazor/performance?#minimize-app-download-size -->
                <!-- https://raw.githubusercontent.com/dotnet/runtime/main/docs/workflow/trimming/feature-switches.md -->
                <PublishTrimmed>true</PublishTrimmed>
                <TrimMode>full</TrimMode>
                <TrimmerRemoveSymbols>true</TrimmerRemoveSymbols>
                <_AggressiveAttributeTrimming>true</_AggressiveAttributeTrimming>
                <AutoreleasePoolSupport>false</AutoreleasePoolSupport>
                <DebuggerSupport>false</DebuggerSupport>
                <EnableCppCLIHostActivation>false</EnableCppCLIHostActivation>
                <EnableUnsafeBinaryFormatterSerialization>false</EnableUnsafeBinaryFormatterSerialization>
                <EnableUnsafeBinaryFormatterInDesigntimeLicenseContextSerialization>false</EnableUnsafeBinaryFormatterInDesigntimeLicenseContextSerialization>
                <EnableUnsafeUTF7Encoding>false</EnableUnsafeUTF7Encoding>
                <_EnableConsumingManagedCodeFromNativeHosting>false</_EnableConsumingManagedCodeFromNativeHosting>
                <EventSourceSupport>false</EventSourceSupport>
                <HttpActivityPropagationSupport>false</HttpActivityPropagationSupport>
                <MetadataUpdaterSupport>false</MetadataUpdaterSupport>
                <UseNativeHttpHandler>true</UseNativeHttpHandler>
                <UseSystemResourceKeys>true</UseSystemResourceKeys>
                <StartupHookSupport>false</StartupHookSupport>
                <CustomResourceTypesSupport>false</CustomResourceTypesSupport>
                <BuiltInComInteropSupport>false</BuiltInComInteropSupport>
                <WasmEmitSourceMap>false</WasmEmitSourceMap>
                <WasmNativeDebugSymbols>false</WasmNativeDebugSymbols>
                <JsonSerializerIsReflectionEnabledByDefault>false</JsonSerializerIsReflectionEnabledByDefault>
            </PropertyGroup>
        </When>
    </Choose>

    <UsingTask TaskName="Bootsharp.Builder.BuildBootsharp" AssemblyFile="$(BootsharpBuilderAssembly)"/>

    <Target Name="BootsharpBuild" AfterTargets="_AfterWasmBuildApp">

        <PropertyGroup>
            <BootsharpBuildDirectory>$(WasmAppDir)/$(WasmRuntimeAssetsLocation)</BootsharpBuildDirectory>
            <BootsharpInspectedDirectory>$(PublishDir)</BootsharpInspectedDirectory>
            <BootsharpEntryAssemblyName>$(AssemblyName).dll</BootsharpEntryAssemblyName>
            <BootSharpBaseOutputPath>$(BaseOutputPath.Replace('\', '/'))</BootSharpBaseOutputPath>
            <BootsharpPublishDirectory Condition="'$(BootsharpPublishDirectory)' == 'default'">$(BootSharpBaseOutputPath)$(BootsharpName)</BootsharpPublishDirectory>
            <BootsharpTypesDirectory Condition="'$(BootsharpTypesDirectory)' == 'default'">$(BootsharpPublishDirectory)/types</BootsharpTypesDirectory>
            <BootsharpBinariesDirectory Condition="'$(BootsharpBinariesDirectory)' == 'default'">$(BootsharpPublishDirectory)/bin</BootsharpBinariesDirectory>
            <BootsharpPackageDirectory Condition="'$(BootsharpPackageDirectory)' == 'default'">$(BootsharpPublishDirectory)</BootsharpPackageDirectory>
        </PropertyGroup>

        <!-- https://github.com/dotnet/runtime/issues/91558 -->
        <PropertyGroup>
            <BootsharpDotNetMain>$(BootsharpBuildDirectory)/dotnet.js</BootsharpDotNetMain>
            <BootsharpDotNetNative>$(BootsharpBuildDirectory)/dotnet.native.js</BootsharpDotNetNative>
        </PropertyGroup>
        <WriteLinesToFile File="$(BootsharpDotNetMain)"
                          Lines="$([System.IO.File]::ReadAllText($(BootsharpDotNetMain)).Replace('=import.meta.url','=&quot;file:/&quot;'))"
                          Overwrite="true"/>
        <WriteLinesToFile File="$(BootsharpDotNetNative)"
                          Lines="$([System.IO.File]::ReadAllText($(BootsharpDotNetNative)).Replace('var _scriptDir = import.meta.url','var _scriptDir = &quot;file:/&quot;'))"
                          Overwrite="true"/>
        <WriteLinesToFile File="$(BootsharpDotNetNative)"
                          Lines="$([System.IO.File]::ReadAllText($(BootsharpDotNetNative)).Replace('new URL('dotnet.native.wasm', import.meta.url).href','&quot;file:/&quot;'))"
                          Overwrite="true"/>

        <!-- Generate bindings, types and (optionally) embed binaries. -->
        <BuildBootsharp BuildDirectory="$(BootsharpBuildDirectory)"
                        InspectedDirectory="$(BootsharpInspectedDirectory)"
                        EntryAssemblyName="$(BootsharpEntryAssemblyName)"
                        EmbedBinaries="$(BootsharpEmbedBinaries)"/>

        <!-- Copy bootsharp source files to the build directory. -->
        <ItemGroup>
            <BootsharpSourceFiles Include="$(BootsharpSourceDirectory)/*.*"/>
        </ItemGroup>
        <Copy SourceFiles="@(BootsharpSourceFiles)" DestinationFolder="$(BootsharpBuildDirectory)"/>
        <Move SourceFiles="$(BootsharpBuildDirectory)/bootsharp.d.ts"
              DestinationFiles="$(BootsharpBuildDirectory)/$(BootsharpName).d.ts"/>

        <!-- Compile generated JavaScript solution. -->
        <Exec Command="npx rollup bootsharp.js -o $(BootsharpName).js -f es -g process,module"
              WorkingDirectory="$(BootsharpBuildDirectory)"
              StdOutEncoding="utf-8" StdErrEncoding="utf-8"/>

        <!-- Publish module, binaries and type declarations. -->
        <ItemGroup>
            <BootsharpModuleFile Include="$(BootsharpBuildDirectory)/$(BootsharpName).js"/>
            <BootsharpWasmFiles Include="$(BootsharpBuildDirectory)/*.wasm"/>
            <BootsharpTypeFiles Include="$(BootsharpBuildDirectory)/*.d.ts"/>
        </ItemGroup>
        <RemoveDir Directories="$(BootsharpBinariesDirectory);$(BootsharpTypesDirectory)"/>
        <Copy Condition="'$(BootsharpEmbedBinaries)' != 'true'"
              SourceFiles="@(BootsharpWasmFiles)"
              DestinationFolder="$(BootsharpBinariesDirectory)"/>
        <Copy SourceFiles="@(BootsharpTypeFiles)"
              DestinationFolder="$(BootsharpTypesDirectory)"/>
        <Copy SourceFiles="@(BootsharpModuleFile)"
              DestinationFolder="$(BootsharpPublishDirectory)"/>

        <!-- Publish package file. -->
        <ItemGroup>
            <BootsharpPackageFile Include="$(BootsharpPackageDirectory)/package.json"/>
        </ItemGroup>
        <WriteLinesToFile Condition="!Exists('$(BootsharpPackageDirectory)/package.json')"
                          File="@(BootsharpPackageFile)"
                          Lines="$([System.IO.File]::ReadAllText('$(BootsharpRoot)/build/PackageTemplate.json')
                                 .Replace('%MODULE_NAME%','$(BootsharpName)')
                                 .Replace('%MODULE_DIR%','$([System.IO.Path]::GetRelativePath('$(BootsharpPackageDirectory)','$(BootsharpPublishDirectory)'))')
                                 .Replace('%TYPES_DIR%','$([System.IO.Path]::GetRelativePath('$(BootsharpPackageDirectory)','$(BootsharpTypesDirectory)'))')
                                 .Replace('\', '/'))"/>

        <Message Text="Bootsharp ES module published at $(BootsharpPublishDirectory)" Importance="high"/>

    </Target>

</Project>
